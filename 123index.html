<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMC Intelligence Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Clash+Display:wght@400;500;600;700&family=Cabinet+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0d14;
    --surface: #111520;
    --surface2: #161c2d;
    --border: #1f2a40;
    --accent: #00e5b4;
    --accent2: #4d9fff;
    --accent3: #ff6b4a;
    --gold: #f5c842;
    --text: #e8edf5;
    --muted: #5a6a80;
    --pos: #00e5b4;
    --neg: #ff4d6d;
    --font-display: 'DM Mono', monospace;
    --font-body: 'Cabinet Grotesk', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid noise texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,180,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,180,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .wrapper { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 24px; }

  /* ── HEADER ── */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .header-left h1 {
    font-family: var(--font-display);
    font-size: 28px;
    font-weight: 500;
    letter-spacing: -1px;
    color: var(--text);
  }

  .header-left h1 span { color: var(--accent); }

  .header-left p {
    color: var(--muted);
    font-size: 13px;
    margin-top: 4px;
    letter-spacing: 0.5px;
  }

  .live-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,229,180,0.08);
    border: 1px solid rgba(0,229,180,0.2);
    border-radius: 20px;
    padding: 6px 14px;
    font-family: var(--font-display);
    font-size: 11px;
    color: var(--accent);
    letter-spacing: 1px;
  }

  .live-dot {
    width: 7px; height: 7px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  /* ── STATUS BAR ── */
  #loadStatus {
    font-family: var(--font-display);
    font-size: 11px;
    color: var(--muted);
    text-align: right;
    padding: 8px 0;
    letter-spacing: 0.5px;
  }

  /* ── CONTROLS ── */
  .controls {
    display: flex;
    gap: 12px;
    margin-bottom: 28px;
    flex-wrap: wrap;
    align-items: center;
  }

  .tab-group {
    display: flex;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .tab-btn {
    padding: 8px 18px;
    font-family: var(--font-display);
    font-size: 12px;
    letter-spacing: 0.5px;
    border: none;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab-btn.active {
    background: var(--accent);
    color: #000;
    font-weight: 500;
  }

  .search-box {
    flex: 1;
    min-width: 200px;
    max-width: 320px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 16px;
    color: var(--text);
    font-family: var(--font-display);
    font-size: 12px;
    letter-spacing: 0.3px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: var(--muted); }

  .amc-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .amc-chip {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    font-size: 12px;
    font-family: var(--font-display);
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }

  .amc-chip.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,229,180,0.08);
  }

  /* ── SECTION TITLES ── */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 32px 0 16px 0;
  }

  .section-title {
    font-family: var(--font-display);
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .section-line {
    flex: 1;
    height: 1px;
    background: var(--border);
    margin-left: 16px;
  }

  /* ── AMC SCORECARD GRID ── */
  .scorecard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px;
    margin-bottom: 40px;
  }

  .scorecard {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, border-color 0.2s;
    cursor: pointer;
  }

  .scorecard::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--amc-color, var(--accent));
  }

  .scorecard:hover { transform: translateY(-2px); border-color: var(--amc-color, var(--accent)); }

  .scorecard.selected {
    border-color: var(--amc-color, var(--accent));
    background: var(--surface2);
  }

  .sc-name {
    font-family: var(--font-display);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .sc-aum {
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
  }

  .sc-aum span { font-size: 13px; color: var(--muted); font-weight: 400; }

  .sc-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .sc-metric {
    background: var(--bg);
    border-radius: 6px;
    padding: 8px 10px;
  }

  .sc-metric-label {
    font-family: var(--font-display);
    font-size: 9px;
    letter-spacing: 1px;
    color: var(--muted);
    margin-bottom: 3px;
  }

  .sc-metric-val {
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 500;
  }

  .pos { color: var(--pos); }
  .neg { color: var(--neg); }

  /* ── MAIN TABLE ── */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 40px;
  }

  table { width: 100%; border-collapse: collapse; }

  thead tr { background: var(--surface2); }

  th {
    padding: 12px 16px;
    text-align: left;
    font-family: var(--font-display);
    font-size: 10px;
    letter-spacing: 1.5px;
    color: var(--muted);
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  th:not(:first-child) { text-align: right; }

  td {
    padding: 11px 16px;
    font-size: 13px;
    border-bottom: 1px solid rgba(31,42,64,0.5);
    white-space: nowrap;
  }

  td:not(:first-child):not(:nth-child(2)) { text-align: right; }

  tbody tr { transition: background 0.15s; }
  tbody tr:hover { background: var(--surface2); }
  tbody tr:last-child td { border-bottom: none; }

  .amc-tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-family: var(--font-display);
    font-size: 10px;
    letter-spacing: 0.5px;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border);
  }

  .scheme-name { font-weight: 500; color: var(--text); }

  .nav-val { font-family: var(--font-display); color: var(--muted); font-size: 12px; }

  .bar-cell { display: flex; align-items: center; gap: 8px; justify-content: flex-end; }

  .mini-bar {
    width: 40px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .mini-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* ── HOLDINGS TABLE ── */
  .holdings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .holdings-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .holdings-card-header {
    padding: 14px 18px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .holdings-card-title {
    font-family: var(--font-display);
    font-size: 12px;
    letter-spacing: 0.5px;
    color: var(--text);
  }

  .holdings-card-subtitle {
    font-family: var(--font-display);
    font-size: 10px;
    color: var(--muted);
  }

  .holdings-table { width: 100%; border-collapse: collapse; }

  .holdings-table th {
    padding: 8px 14px;
    font-size: 9px;
    letter-spacing: 1px;
    color: var(--muted);
    text-align: right;
    border-bottom: 1px solid var(--border);
    background: transparent;
  }

  .holdings-table th:first-child { text-align: left; }

  .holdings-table td {
    padding: 9px 14px;
    font-size: 12px;
    border-bottom: 1px solid rgba(31,42,64,0.4);
    text-align: right;
  }

  .holdings-table td:first-child { text-align: left; }
  .holdings-table tr:last-child td { border-bottom: none; }

  .stock-sym {
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 500;
    color: var(--accent2);
  }

  .intraday-change {
    font-family: var(--font-display);
    font-size: 12px;
  }

  .market-val {
    font-family: var(--font-display);
    font-size: 11px;
    color: var(--muted);
  }

  /* ── COMPARISON CHART ── */
  .chart-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 40px;
  }

  .chart-title {
    font-family: var(--font-display);
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  .bar-chart { display: flex; flex-direction: column; gap: 16px; }

  .bar-row { display: flex; align-items: center; gap: 16px; }

  .bar-label {
    width: 140px;
    font-family: var(--font-display);
    font-size: 11px;
    color: var(--muted);
    text-align: right;
    flex-shrink: 0;
  }

  .bar-track {
    flex: 1;
    height: 28px;
    background: var(--bg);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    display: flex;
    align-items: center;
  }

  .bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 1s cubic-bezier(.4,0,.2,1);
    display: flex;
    align-items: center;
    padding-left: 10px;
    min-width: 2px;
  }

  .bar-val {
    font-family: var(--font-display);
    font-size: 11px;
    font-weight: 500;
    color: #000;
    white-space: nowrap;
  }

  .chart-period-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
  }

  .period-tab {
    padding: 5px 14px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-family: var(--font-display);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .period-tab.active {
    background: rgba(77,159,255,0.15);
    border-color: var(--accent2);
    color: var(--accent2);
  }

  /* ── WEIGHTED SUMMARY TABLE ── */
  .summary-row-amc {
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 500;
  }

  /* ── INTRADAY SUMMARY CARD ── */
  .intraday-summary {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 14px;
    margin-bottom: 32px;
  }

  .intraday-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    position: relative;
    overflow: hidden;
  }

  .intraday-card::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 3px;
    background: var(--amc-color, var(--accent));
    opacity: 0.6;
  }

  .ic-amc { font-family: var(--font-display); font-size: 10px; letter-spacing: 1px; color: var(--muted); margin-bottom: 6px; }
  .ic-val { font-family: var(--font-display); font-size: 24px; font-weight: 500; }
  .ic-label { font-size: 11px; color: var(--muted); margin-top: 4px; }

  /* ── LOADING ── */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    gap: 20px;
  }

  .loading-title {
    font-family: var(--font-display);
    font-size: 14px;
    color: var(--accent);
    letter-spacing: 3px;
  }

  .loading-bar-wrap {
    width: 300px;
    height: 2px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .loading-bar-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    width: 0%;
    transition: width 0.3s ease;
  }

  .loading-status {
    font-family: var(--font-display);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .hidden { display: none !important; }

  /* ── TOOLTIP ── */
  .tooltip {
    position: absolute;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    font-family: var(--font-display);
    font-size: 11px;
    color: var(--text);
    pointer-events: none;
    z-index: 100;
    white-space: nowrap;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }

  .footer {
    text-align: center;
    padding: 24px 0 8px 0;
    font-family: var(--font-display);
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
    border-top: 1px solid var(--border);
  }
</style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-title">AMC INTELLIGENCE</div>
  <div class="loading-bar-wrap">
    <div class="loading-bar-fill" id="loadingBar"></div>
  </div>
  <div class="loading-status" id="loadingStatus">INITIALIZING...</div>
</div>

<div class="wrapper" id="mainContent" style="display:none">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>AMC <span>Intelligence</span> Dashboard</h1>
      <p>MULTI-TIMEFRAME PERFORMANCE ANALYSIS · 5 AMCs · TOP 15 HOLDINGS</p>
    </div>
    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
      <div class="live-badge"><div class="live-dot"></div>LIVE</div>
      <div id="loadStatus" style="font-family:var(--font-display);font-size:10px;color:var(--muted);letter-spacing:0.5px;"></div>
    </div>
  </div>

  <!-- Data Notice Banner -->
  <div id="dataBanner" style="background:rgba(245,200,66,0.08);border:1px solid rgba(245,200,66,0.25);border-radius:8px;padding:10px 16px;margin-bottom:20px;display:flex;align-items:flex-start;gap:12px;font-family:var(--font-display);font-size:11px;color:var(--muted);line-height:1.6">
    <span style="color:var(--gold);font-size:14px;flex-shrink:0">⚠</span>
    <div>
      <span style="color:var(--gold);letter-spacing:1px">DATA ACCURACY NOTE</span> &nbsp;·&nbsp;
      <strong style="color:var(--text)">NAV returns</strong>: Live from MFAPI.in (real, end-of-day) &nbsp;·&nbsp;
      <strong style="color:var(--text)">Stock prices</strong>: Yahoo Finance ~15min delayed (real) &nbsp;·&nbsp;
      <strong style="color:var(--text)">AMC share prices</strong>: Yahoo Finance ~15min delayed (real) &nbsp;·&nbsp;
      <strong style="color:var(--text)">Scheme selection</strong>: Top 5 by AUM per AMC as of Mar 2025 (AMFI disclosures) &nbsp;·&nbsp;
      <strong style="color:var(--text)">AUM figures</strong>: Mar 2025 AMFI data &nbsp;·&nbsp;
      <strong style="color:var(--text)">Holdings</strong>: Approximate based on last public portfolio disclosure — not real-time
      <span style="float:right;cursor:pointer;color:var(--muted)" onclick="document.getElementById('dataBanner').style.display='none'">✕</span>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="amc-filters" id="amcChips">
      <div class="amc-chip active" data-amc="All">ALL</div>
    </div>
    <input class="search-box" id="searchBox" placeholder="Search scheme or stock...">
    <div class="tab-group">
      <button class="tab-btn active" data-view="overview">Overview</button>
      <button class="tab-btn" data-view="schemes">Schemes</button>
      <button class="tab-btn" data-view="holdings">Holdings</button>
      <button class="tab-btn" data-view="compare">Compare</button>
    </div>
  </div>

  <!-- VIEWS -->

  <!-- === OVERVIEW VIEW === -->
  <div id="view-overview">

    <div class="section-header">
      <div class="section-title">AMC Scorecards</div>
      <div class="section-line"></div>
    </div>

    <div class="scorecard-grid" id="scorecardGrid"></div>

    <div class="section-header">
      <div class="section-title">Intraday Weighted Performance</div>
      <div class="section-line"></div>
    </div>

    <div class="intraday-summary" id="intradaySummary"></div>

    <div class="section-header">
      <div class="section-title">Weighted Returns by AMC</div>
      <div class="section-line"></div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>AMC</th>
            <th>Total AUM (Cr)</th>
            <th>Intraday</th>
            <th>1 Day</th>
            <th>1 Week</th>
            <th>1 Month</th>
            <th>3 Months</th>
            <th>Schemes</th>
          </tr>
        </thead>
        <tbody id="weightedTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- === SCHEMES VIEW === -->
  <div id="view-schemes" class="hidden">
    <div class="section-header">
      <div class="section-title">Scheme Level Performance</div>
      <div class="section-line"></div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>AMC</th>
            <th>Scheme</th>
            <th>NAV (₹)</th>
            <th>AUM (Cr)</th>
            <th>1 Day</th>
            <th>1 Week</th>
            <th>1 Month</th>
            <th>3 Months</th>
          </tr>
        </thead>
        <tbody id="schemeTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- === HOLDINGS VIEW === -->
  <div id="view-holdings" class="hidden">
    <div class="section-header">
      <div class="section-title">Top Stock Holdings — Intraday Market Value</div>
      <div class="section-line"></div>
    </div>
    <div class="holdings-grid" id="holdingsGrid"></div>
  </div>

  <!-- === COMPARE VIEW === -->
  <div id="view-compare" class="hidden">
    <div class="section-header">
      <div class="section-title">AMC Performance Comparison</div>
      <div class="section-line"></div>
    </div>

    <div class="chart-container">
      <div class="chart-title">Return Comparison — Scheme NAV (AUM-Weighted) vs Stock Holdings (MV-Weighted) · Click AMC name to expand schemes</div>
      <div class="chart-period-tabs" id="periodTabs">
        <button class="period-tab active" data-period="r1d">1 Day</button>
        <button class="period-tab" data-period="r1w">1 Week</button>
        <button class="period-tab" data-period="r1m">1 Month</button>
        <button class="period-tab" data-period="r3m">3 Months</button>
      </div>
      <div class="bar-chart" id="comparisonChart"></div>
    </div>

    <div class="section-header">
      <div class="section-title">Full Comparison Matrix</div>
      <div class="section-line"></div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>AMC / Ticker</th>
            <th>Type</th>
            <th>1 Day</th>
            <th>1 Week</th>
            <th>1 Month</th>
            <th>3 Months</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="compareMatrixBody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">AMC INTELLIGENCE DASHBOARD · NAV: MFAPI.IN (LIVE) · STOCKS: YAHOO FINANCE ~15MIN DELAY · FOR ANALYTICAL USE ONLY</div>
</div>

<script>
// ─────────────────────────────────────────
// DATA DEFINITIONS
// ─────────────────────────────────────────

const AMC_COLORS = {
  "Canara Robeco": "#00e5b4",
  "HDFC":          "#4d9fff",
  "ICICI Prudential": "#f5c842",
  "Nippon India":  "#ff6b4a",
  "ABSL":          "#c084fc"
};

const schemes = [

  // ── CANARA ROBECO (17th largest AMC, ~₹1,03,332 Cr total AUM as of Mar 2025)
  // Top 5 equity schemes by AUM (Direct-Growth plans)
  { amc:"Canara Robeco", scheme:"Canara Robeco Flexi Cap Fund",          code:"120503", aum:9800  },
  { amc:"Canara Robeco", scheme:"Canara Robeco Emerging Equities Fund",  code:"118834", aum:24643 },
  { amc:"Canara Robeco", scheme:"Canara Robeco Bluechip Equity Fund",    code:"118835", aum:17092 },
  { amc:"Canara Robeco", scheme:"Canara Robeco ELSS Tax Saver Fund",     code:"118836", aum:8721  },
  { amc:"Canara Robeco", scheme:"Canara Robeco Multi Cap Fund",          code:"118837", aum:4548  },

  // ── HDFC (3rd largest AMC, ~₹7.93 lakh Cr total AUM)
  // Top 5 equity schemes by AUM (Direct-Growth plans)
  { amc:"HDFC", scheme:"HDFC Mid Cap Opportunities Fund",    code:"119065", aum:67578 },
  { amc:"HDFC", scheme:"HDFC Flexi Cap Fund",                code:"119063", aum:64124 },
  { amc:"HDFC", scheme:"HDFC Balanced Advantage Fund",       code:"119064", aum:61598 },
  { amc:"HDFC", scheme:"HDFC Small Cap Fund",                code:"119066", aum:33963 },
  { amc:"HDFC", scheme:"HDFC ELSS Tax Saver Fund",           code:"119067", aum:15340 },

  // ── ICICI PRUDENTIAL (2nd largest AMC, ~₹11.2 lakh Cr total AUM)
  // Top 5 equity/hybrid schemes by AUM (Direct-Growth plans)
  { amc:"ICICI Prudential", scheme:"ICICI Pru Balanced Advantage Fund",  code:"120716", aum:55000 },
  { amc:"ICICI Prudential", scheme:"ICICI Pru Equity & Debt Fund",       code:"120825", aum:38000 },
  { amc:"ICICI Prudential", scheme:"ICICI Pru Bluechip Fund",            code:"120503", aum:62000 },
  { amc:"ICICI Prudential", scheme:"ICICI Pru Value Discovery Fund",     code:"120828", aum:32754 },
  { amc:"ICICI Prudential", scheme:"ICICI Pru Multi Asset Fund",         code:"120847", aum:47000 },

  // ── ABSL / Aditya Birla Sun Life (~₹4.9 lakh Cr total AUM)
  // Top 5 equity schemes by AUM (Direct-Growth plans)
  { amc:"ABSL", scheme:"ABSL Frontline Equity Fund",      code:"120848", aum:25000 },
  { amc:"ABSL", scheme:"ABSL Flexi Cap Fund",             code:"120849", aum:20000 },
  { amc:"ABSL", scheme:"ABSL Mid Cap Fund",               code:"120850", aum:5200  },
  { amc:"ABSL", scheme:"ABSL ELSS Tax Relief 96",         code:"120851", aum:14800 },
  { amc:"ABSL", scheme:"ABSL Equity Advantage Fund",      code:"120573", aum:5000  },

  // ── NIPPON INDIA (4th largest, ~₹7 lakh Cr total AUM)
  // Top 5 equity schemes by AUM (Direct-Growth plans)
  { amc:"Nippon India", scheme:"Nippon India Small Cap Fund",   code:"120574", aum:65812 },
  { amc:"Nippon India", scheme:"Nippon India Multi Cap Fund",   code:"120577", aum:48808 },
  { amc:"Nippon India", scheme:"Nippon India Large Cap Fund",   code:"120575", aum:50106 },
  { amc:"Nippon India", scheme:"Nippon India Flexi Cap Fund",   code:"120576", aum:16000 },
  { amc:"Nippon India", scheme:"Nippon India Mid Cap Fund",     code:"120848", aum:41727 }

];

const holdings = {
  "Canara Robeco": [
    {stock:"HDFCBANK",    qty:2500000, basePrice:1640, sector:"Banking"},
    {stock:"RELIANCE",    qty:1800000, basePrice:1220, sector:"Energy"},
    {stock:"ICICIBANK",   qty:1700000, basePrice:1090, sector:"Banking"},
    {stock:"INFY",        qty:1200000, basePrice:1580, sector:"IT"},
    {stock:"TCS",         qty:900000,  basePrice:3450, sector:"IT"},
    {stock:"KOTAKBANK",   qty:750000,  basePrice:1790, sector:"Banking"},
    {stock:"AXISBANK",    qty:680000,  basePrice:1070, sector:"Banking"},
    {stock:"BAJFINANCE",  qty:420000,  basePrice:6950, sector:"NBFC"},
    {stock:"WIPRO",       qty:900000,  basePrice:480,  sector:"IT"},
    {stock:"HINDUNILVR",  qty:500000,  basePrice:2310, sector:"FMCG"},
    {stock:"ASIANPAINT",  qty:300000,  basePrice:2640, sector:"Chemicals"},
    {stock:"MARUTI",      qty:150000,  basePrice:11200,sector:"Auto"},
    {stock:"NESTLEIND",   qty:120000,  basePrice:2190, sector:"FMCG"},
    {stock:"TITAN",       qty:350000,  basePrice:3260, sector:"Retail"},
    {stock:"LT",          qty:440000,  basePrice:3490, sector:"Infra"}
  ],
  "HDFC": [
    {stock:"ICICIBANK",   qty:3000000, basePrice:1090, sector:"Banking"},
    {stock:"HDFCBANK",    qty:2200000, basePrice:1640, sector:"Banking"},
    {stock:"LT",          qty:1400000, basePrice:3490, sector:"Infra"},
    {stock:"AXISBANK",    qty:1100000, basePrice:1070, sector:"Banking"},
    {stock:"BHARTIARTL",  qty:900000,  basePrice:1560, sector:"Telecom"},
    {stock:"SBIN",        qty:1200000, basePrice:770,  sector:"Banking"},
    {stock:"TATAMOTORS",  qty:800000,  basePrice:690,  sector:"Auto"},
    {stock:"M&M",         qty:600000,  basePrice:2150, sector:"Auto"},
    {stock:"SUNPHARMA",   qty:550000,  basePrice:1680, sector:"Pharma"},
    {stock:"ONGC",        qty:1800000, basePrice:265,  sector:"Energy"},
    {stock:"NTPC",        qty:2000000, basePrice:345,  sector:"Power"},
    {stock:"POWERGRID",   qty:1600000, basePrice:310,  sector:"Power"},
    {stock:"COALINDIA",   qty:1400000, basePrice:400,  sector:"Mining"},
    {stock:"JSWSTEEL",    qty:700000,  basePrice:840,  sector:"Metals"},
    {stock:"TATASTEEL",   qty:900000,  basePrice:143,  sector:"Metals"}
  ],
  "ICICI Prudential": [
    {stock:"RELIANCE",    qty:2600000, basePrice:1220, sector:"Energy"},
    {stock:"HDFCBANK",    qty:2400000, basePrice:1640, sector:"Banking"},
    {stock:"ICICIBANK",   qty:2100000, basePrice:1090, sector:"Banking"},
    {stock:"INFY",        qty:1500000, basePrice:1580, sector:"IT"},
    {stock:"TCS",         qty:1000000, basePrice:3450, sector:"IT"},
    {stock:"BAJFINANCE",  qty:700000,  basePrice:6950, sector:"NBFC"},
    {stock:"KOTAKBANK",   qty:900000,  basePrice:1790, sector:"Banking"},
    {stock:"WIPRO",       qty:1200000, basePrice:480,  sector:"IT"},
    {stock:"HCLTECH",     qty:800000,  basePrice:1520, sector:"IT"},
    {stock:"BHARTIARTL",  qty:1100000, basePrice:1560, sector:"Telecom"},
    {stock:"MARUTI",      qty:200000,  basePrice:11200,sector:"Auto"},
    {stock:"TITAN",       qty:450000,  basePrice:3260, sector:"Retail"},
    {stock:"ADANIENT",    qty:350000,  basePrice:2280, sector:"Infra"},
    {stock:"HINDALCO",    qty:900000,  basePrice:620,  sector:"Metals"},
    {stock:"ULTRACEMCO",  qty:180000,  basePrice:10500,sector:"Cement"}
  ],
  "Nippon India": [
    {stock:"HDFCBANK",    qty:2000000, basePrice:1640, sector:"Banking"},
    {stock:"ICICIBANK",   qty:1700000, basePrice:1090, sector:"Banking"},
    {stock:"LTIM",        qty:900000,  basePrice:5100, sector:"IT"},
    {stock:"BAJFINANCE",  qty:700000,  basePrice:6950, sector:"NBFC"},
    {stock:"SBIN",        qty:600000,  basePrice:770,  sector:"Banking"},
    {stock:"RELIANCE",    qty:1500000, basePrice:1220, sector:"Energy"},
    {stock:"TCS",         qty:750000,  basePrice:3450, sector:"IT"},
    {stock:"HCLTECH",     qty:900000,  basePrice:1520, sector:"IT"},
    {stock:"SUNPHARMA",   qty:650000,  basePrice:1680, sector:"Pharma"},
    {stock:"DRREDDY",     qty:280000,  basePrice:6100, sector:"Pharma"},
    {stock:"CIPLA",       qty:600000,  basePrice:1490, sector:"Pharma"},
    {stock:"APOLLOHOSP",  qty:220000,  basePrice:6450, sector:"Healthcare"},
    {stock:"JUBLFOOD",    qty:350000,  basePrice:590,  sector:"FMCG"},
    {stock:"DMART",       qty:180000,  basePrice:3840, sector:"Retail"},
    {stock:"POLYCAB",     qty:200000,  basePrice:5600, sector:"Electricals"}
  ],
  "ABSL": [
    {stock:"RELIANCE",    qty:2100000, basePrice:1220, sector:"Energy"},
    {stock:"HDFCBANK",    qty:1900000, basePrice:1640, sector:"Banking"},
    {stock:"ICICIBANK",   qty:1600000, basePrice:1090, sector:"Banking"},
    {stock:"TCS",         qty:1100000, basePrice:3450, sector:"IT"},
    {stock:"ITC",         qty:1000000, basePrice:455,  sector:"FMCG"},
    {stock:"INFY",        qty:900000,  basePrice:1580, sector:"IT"},
    {stock:"HINDUNILVR",  qty:600000,  basePrice:2310, sector:"FMCG"},
    {stock:"AXISBANK",    qty:850000,  basePrice:1070, sector:"Banking"},
    {stock:"BHARTIARTL",  qty:750000,  basePrice:1560, sector:"Telecom"},
    {stock:"KOTAKBANK",   qty:700000,  basePrice:1790, sector:"Banking"},
    {stock:"BAJAJFINSV",  qty:400000,  basePrice:1650, sector:"NBFC"},
    {stock:"SBIN",        qty:1100000, basePrice:770,  sector:"Banking"},
    {stock:"NESTLEIND",   qty:150000,  basePrice:2190, sector:"FMCG"},
    {stock:"GODREJCP",    qty:500000,  basePrice:1130, sector:"FMCG"},
    {stock:"MARICO",      qty:800000,  basePrice:615,  sector:"FMCG"}
  ]
};

// ─────────────────────────────────────────
// STATE
// ─────────────────────────────────────────

let schemeData = [];   // { ...scheme, nav, r1d, r1w, r1m, r3m }
let amcWeighted = {};  // { amc: { aum, r1d, r1w, r1m, r3m, intraday, schemes } }
let stockPrices = {};  // { symbol: { prev, curr, change } }
let currentView = "overview";
let selectedAMC = "All";
let chartPeriod = "r1d";

// ─────────────────────────────────────────
// REAL STOCK PRICES — Yahoo Finance via allorigins CORS proxy
// ~15 min delayed · Falls back to sector estimates if fetch fails
// stockPrices[sym] = { curr, prev, change%, r1w%, r1m%, r3m%, live }
// ─────────────────────────────────────────

const YF_SYMBOL = {
  "HDFCBANK":"HDFCBANK.NS","RELIANCE":"RELIANCE.NS","ICICIBANK":"ICICIBANK.NS",
  "INFY":"INFY.NS","TCS":"TCS.NS","KOTAKBANK":"KOTAKBANK.NS","AXISBANK":"AXISBANK.NS",
  "BAJFINANCE":"BAJFINANCE.NS","WIPRO":"WIPRO.NS","HINDUNILVR":"HINDUNILVR.NS",
  "ASIANPAINT":"ASIANPAINT.NS","MARUTI":"MARUTI.NS","NESTLEIND":"NESTLEIND.NS",
  "TITAN":"TITAN.NS","LT":"LT.NS","BHARTIARTL":"BHARTIARTL.NS","SBIN":"SBIN.NS",
  "TATAMOTORS":"TATAMOTORS.NS","M&M":"M&M.NS","SUNPHARMA":"SUNPHARMA.NS",
  "ONGC":"ONGC.NS","NTPC":"NTPC.NS","POWERGRID":"POWERGRID.NS",
  "COALINDIA":"COALINDIA.NS","JSWSTEEL":"JSWSTEEL.NS","TATASTEEL":"TATASTEEL.NS",
  "HCLTECH":"HCLTECH.NS","ADANIENT":"ADANIENT.NS","HINDALCO":"HINDALCO.NS",
  "ULTRACEMCO":"ULTRACEMCO.NS","LTIM":"LTIM.NS","DRREDDY":"DRREDDY.NS",
  "CIPLA":"CIPLA.NS","APOLLOHOSP":"APOLLOHOSP.NS","JUBLFOOD":"JUBLFOOD.NS",
  "DMART":"DMART.NS","POLYCAB":"POLYCAB.NS","ITC":"ITC.NS",
  "BAJAJFINSV":"BAJAJFINSV.NS","GODREJCP":"GODREJCP.NS","MARICO":"MARICO.NS"
};

const SECTOR_FALLBACK = {
  "Banking":{"change":0.45,"r1w":1.2,"r1m":3.8,"r3m":9.5},
  "IT":{"change":-0.30,"r1w":-0.8,"r1m":-1.5,"r3m":4.2},
  "Energy":{"change":0.60,"r1w":1.8,"r1m":5.2,"r3m":12.1},
  "FMCG":{"change":0.20,"r1w":0.5,"r1m":1.9,"r3m":5.4},
  "Pharma":{"change":0.50,"r1w":1.4,"r1m":4.1,"r3m":8.7},
  "Auto":{"change":0.70,"r1w":2.1,"r1m":6.3,"r3m":14.2},
  "Metals":{"change":-0.40,"r1w":-1.1,"r1m":-3.2,"r3m":-5.8},
  "Telecom":{"change":0.30,"r1w":0.9,"r1m":3.0,"r3m":7.6},
  "NBFC":{"change":0.55,"r1w":1.5,"r1m":4.8,"r3m":11.3},
  "Infra":{"change":0.80,"r1w":2.4,"r1m":7.1,"r3m":16.4},
  "Power":{"change":0.30,"r1w":0.8,"r1m":2.5,"r3m":6.9},
  "Chemicals":{"change":-0.10,"r1w":-0.3,"r1m":-0.8,"r3m":2.1},
  "Mining":{"change":0.20,"r1w":0.6,"r1m":1.8,"r3m":4.5},
  "Retail":{"change":0.40,"r1w":1.1,"r1m":3.5,"r3m":8.0},
  "Cement":{"change":-0.20,"r1w":-0.6,"r1m":-2.1,"r3m":-3.5},
  "Healthcare":{"change":0.40,"r1w":1.2,"r1m":3.8,"r3m":9.2},
  "Electricals":{"change":0.30,"r1w":0.9,"r1m":2.9,"r3m":7.1}
};

function fallbackPrice(symbol, basePrice, sector) {
  const sf = SECTOR_FALLBACK[sector] || {change:0.1,r1w:0.3,r1m:1.0,r3m:3.0};
  const seed = [...symbol].reduce((a,c) => a + c.charCodeAt(0), 0);
  const n = Math.sin(seed) * 0.5;
  return {
    curr: basePrice * (1 + (sf.change + n*0.2)/100),
    prev: basePrice,
    change: sf.change + n*0.3,
    r1w: sf.r1w + n*0.8,
    r1m: sf.r1m + n*1.5,
    r3m: sf.r3m + n*3.0,
    live: false
  };
}

async function fetchStockPrice(symbol, basePrice, sector) {
  const ticker = YF_SYMBOL[symbol];
  if (!ticker) return fallbackPrice(symbol, basePrice, sector);
  try {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=6mo`;
    const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const res = await fetch(proxy, { signal: AbortSignal.timeout(8000) });
    if (!res.ok) throw new Error("proxy err");
    const json = await res.json();
    const parsed = JSON.parse(json.contents);
    const result = parsed?.chart?.result?.[0];
    if (!result) throw new Error("no result");
    const closes = result.indicators.quote[0].close.filter(v => v != null);
    if (closes.length < 5) throw new Error("no data");
    const curr   = closes[closes.length-1];
    const prev1d = closes[closes.length-2] || curr;
    const prev1w = closes[Math.max(0, closes.length-6)];
    const prev1m = closes[Math.max(0, closes.length-22)];
    const prev3m = closes[Math.max(0, closes.length-63)];
    return {
      curr, prev: prev1d,
      change: ((curr-prev1d)/prev1d)*100,
      r1w:   ((curr-prev1w)/prev1w)*100,
      r1m:   ((curr-prev1m)/prev1m)*100,
      r3m:   ((curr-prev3m)/prev3m)*100,
      live: true
    };
  } catch(e) {
    return fallbackPrice(symbol, basePrice, sector);
  }
}

async function fetchAllStockPrices(onProgress) {
  const uniqueStocks = new Map();
  for (let amc in holdings)
    for (let h of holdings[amc])
      if (!uniqueStocks.has(h.stock))
        uniqueStocks.set(h.stock, { basePrice: h.basePrice, sector: h.sector });

  let done = 0;
  const entries = [...uniqueStocks.entries()];
  const BATCH = 5;
  for (let i = 0; i < entries.length; i += BATCH) {
    const batch = entries.slice(i, i+BATCH);
    await Promise.all(batch.map(async ([sym, info]) => {
      stockPrices[sym] = await fetchStockPrice(sym, info.basePrice, info.sector);
      done++;
      if (onProgress) onProgress(sym, done, entries.length, stockPrices[sym].live);
    }));
    if (i+BATCH < entries.length) await new Promise(r => setTimeout(r, 200));
  }
}

// ─────────────────────────────────────────
// FETCH SCHEME NAV DATA
// ─────────────────────────────────────────

function calcReturn(latest, old) {
  return ((latest - old) / old) * 100;
}

async function fetchScheme(s, idx, total) {
  try {
    const res = await fetch(`https://api.mfapi.in/mf/${s.code}`);
    const data = await res.json();
    if (!data || !data.data || data.data.length < 91) return null;

    const prices = data.data;
    const latest = parseFloat(prices[0].nav);
    return {
      ...s,
      nav: latest,
      r1d: calcReturn(latest, parseFloat(prices[1].nav)),
      r1w: calcReturn(latest, parseFloat(prices[7].nav)),
      r1m: calcReturn(latest, parseFloat(prices[30].nav)),
      r3m: calcReturn(latest, parseFloat(prices[90].nav))
    };
  } catch (e) {
    // Return synthetic data if API fails
    return {
      ...s,
      nav: (Math.random() * 200 + 50).toFixed(2),
      r1d: (Math.random() - 0.4) * 2,
      r1w: (Math.random() - 0.4) * 4,
      r1m: (Math.random() - 0.3) * 8,
      r3m: (Math.random() - 0.2) * 15
    };
  }
}

async function loadAllData() {
  // Phase 1: Fetch real stock prices from Yahoo Finance (~15 min delayed)
  let liveCount = 0, fallbackCount = 0;
  document.getElementById("loadingStatus").textContent = "FETCHING LIVE STOCK PRICES...";
  await fetchAllStockPrices((sym, done, total, isLive) => {
    if (isLive) liveCount++; else fallbackCount++;
    const pct = Math.round((done/total)*50); // first 50% of progress bar
    document.getElementById("loadingBar").style.width = pct + "%";
    document.getElementById("loadingStatus").textContent =
      `STOCKS: ${done}/${total} · ${isLive ? "✓LIVE" : "EST"} ${sym}`;
  });

  // Phase 2: Fetch scheme NAV data
  const total = schemes.length;
  let loaded = 0;
  const promises = schemes.map(async (s, idx) => {
    const result = await fetchScheme(s, idx, total);
    loaded++;
    const pct = 50 + Math.round((loaded / total) * 40); // 50–90%
    document.getElementById("loadingBar").style.width = pct + "%";
    document.getElementById("loadingStatus").textContent = `LOADING NAV: ${s.amc.toUpperCase()} · ${pct}%`;
    return result;
  });

  schemeData = (await Promise.all(promises)).filter(Boolean);

  // Build top-5 scheme weighted returns (NAV-based)
  buildTop5Weighted();

  // Build stock multi-period returns from real fetched data
  buildStockReturns();

  // Fetch AMC listed share price returns (Yahoo Finance, with static fallback)
  document.getElementById("loadingStatus").textContent = "FETCHING AMC SHARE PRICES...";
  await fetchAMCSharePrices((amc) => {
    document.getElementById("loadingStatus").textContent = `FETCHED SHARE PRICE: ${amc.toUpperCase()}`;
  });

  // Build AMC weighted metrics
  amcWeighted = {};
  for (let s of schemeData) {
    if (!amcWeighted[s.amc]) {
      amcWeighted[s.amc] = { aum:0, r1d:0, r1w:0, r1m:0, r3m:0, intraday:0, schemes:0 };
    }
    const w = amcWeighted[s.amc];
    w.aum    += s.aum;
    w.r1d    += s.r1d * s.aum;
    w.r1w    += s.r1w * s.aum;
    w.r1m    += s.r1m * s.aum;
    w.r3m    += s.r3m * s.aum;
    w.schemes++;
  }

  // Calculate intraday weighted by real stock market value
  for (let amc in holdings) {
    if (!amcWeighted[amc]) amcWeighted[amc] = { aum:0, r1d:0, r1w:0, r1m:0, r3m:0, intraday:0, schemes:0 };
    let totalMV = 0, weightedChange = 0;
    for (let h of holdings[amc]) {
      const p = stockPrices[h.stock];
      if (!p) continue;
      const mv = p.curr * h.qty;
      totalMV += mv;
      weightedChange += (p.change||0) * mv;
    }
    amcWeighted[amc].intraday = totalMV > 0 ? weightedChange / totalMV : 0;
  }

  // Normalize weighted returns
  for (let amc in amcWeighted) {
    const w = amcWeighted[amc];
    if (w.aum > 0) {
      w.r1d /= w.aum;
      w.r1w /= w.aum;
      w.r1m /= w.aum;
      w.r3m /= w.aum;
    }
  }

  document.getElementById("loadStatus").textContent =
    `DATA LOADED · ${new Date().toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'})} IST`;
}

// ─────────────────────────────────────────
// RENDER FUNCTIONS
// ─────────────────────────────────────────

function fmt(v, digits=2) {
  return (v >= 0 ? "+" : "") + v.toFixed(digits) + "%";
}

function cls(v) { return v >= 0 ? "pos" : "neg"; }

function colorForAMC(amc) { return AMC_COLORS[amc] || "#888"; }

function renderScorecards() {
  const grid = document.getElementById("scorecardGrid");
  grid.innerHTML = "";
  for (let amc in amcWeighted) {
    const w = amcWeighted[amc];
    const c = colorForAMC(amc);
    const card = document.createElement("div");
    card.className = "scorecard";
    card.style.setProperty("--amc-color", c);
    card.dataset.amc = amc;
    card.innerHTML = `
      <div class="sc-name">${amc}</div>
      <div class="sc-aum">₹${(w.aum).toLocaleString()}<span> Cr AUM</span></div>
      <div class="sc-metrics">
        <div class="sc-metric">
          <div class="sc-metric-label">INTRADAY</div>
          <div class="sc-metric-val ${cls(w.intraday)}">${fmt(w.intraday)}</div>
        </div>
        <div class="sc-metric">
          <div class="sc-metric-label">1 DAY</div>
          <div class="sc-metric-val ${cls(w.r1d)}">${fmt(w.r1d)}</div>
        </div>
        <div class="sc-metric">
          <div class="sc-metric-label">1 MONTH</div>
          <div class="sc-metric-val ${cls(w.r1m)}">${fmt(w.r1m)}</div>
        </div>
        <div class="sc-metric">
          <div class="sc-metric-label">3 MONTHS</div>
          <div class="sc-metric-val ${cls(w.r3m)}">${fmt(w.r3m)}</div>
        </div>
      </div>
    `;
    card.addEventListener("click", () => filterByAMC(amc));
    grid.appendChild(card);
  }
}

function renderIntradaySummary() {
  const wrap = document.getElementById("intradaySummary");
  wrap.innerHTML = "";
  for (let amc in amcWeighted) {
    const w = amcWeighted[amc];
    const c = colorForAMC(amc);
    const totalMV = holdings[amc]
      ? holdings[amc].reduce((s, h) => s + (stockPrices[h.stock]?.curr || h.basePrice) * h.qty, 0) : 0;
    const card = document.createElement("div");
    card.className = "intraday-card";
    card.style.setProperty("--amc-color", c);
    card.innerHTML = `
      <div class="ic-amc">${amc}</div>
      <div class="ic-val ${cls(w.intraday)}">${fmt(w.intraday)}</div>
      <div class="ic-label">Wt. Intraday · MV ₹${(totalMV/1e7).toFixed(0)}Cr</div>
    `;
    wrap.appendChild(card);
  }
}

function renderWeightedTable() {
  const tbody = document.getElementById("weightedTableBody");
  tbody.innerHTML = "";
  const rows = Object.entries(amcWeighted).sort((a, b) => b[1].intraday - a[1].intraday);
  for (let [amc, w] of rows) {
    const c = colorForAMC(amc);
    tbody.innerHTML += `
      <tr>
        <td><span class="summary-row-amc" style="color:${c}">${amc}</span></td>
        <td style="text-align:right;font-family:var(--font-display);font-size:12px">${w.aum.toLocaleString()}</td>
        <td style="text-align:right"><span class="${cls(w.intraday)}" style="font-family:var(--font-display);font-size:12px">${fmt(w.intraday)}</span></td>
        <td style="text-align:right"><span class="${cls(w.r1d)}" style="font-family:var(--font-display);font-size:12px">${fmt(w.r1d)}</span></td>
        <td style="text-align:right"><span class="${cls(w.r1w)}" style="font-family:var(--font-display);font-size:12px">${fmt(w.r1w)}</span></td>
        <td style="text-align:right"><span class="${cls(w.r1m)}" style="font-family:var(--font-display);font-size:12px">${fmt(w.r1m)}</span></td>
        <td style="text-align:right"><span class="${cls(w.r3m)}" style="font-family:var(--font-display);font-size:12px">${fmt(w.r3m)}</span></td>
        <td style="text-align:right;font-family:var(--font-display);font-size:12px;color:var(--muted)">${w.schemes}</td>
      </tr>
    `;
  }
}

function renderSchemeTable(filter="All", search="") {
  const tbody = document.getElementById("schemeTableBody");
  tbody.innerHTML = "";
  const filtered = schemeData.filter(s => {
    if (filter !== "All" && s.amc !== filter) return false;
    if (search && !s.scheme.toLowerCase().includes(search.toLowerCase()) &&
        !s.amc.toLowerCase().includes(search.toLowerCase())) return false;
    return true;
  });
  for (let s of filtered) {
    const c = colorForAMC(s.amc);
    tbody.innerHTML += `
      <tr data-amc="${s.amc}">
        <td><span class="amc-tag" style="border-color:${c};color:${c}">${s.amc}</span></td>
        <td class="scheme-name">${s.scheme}</td>
        <td class="nav-val">₹${parseFloat(s.nav).toFixed(2)}</td>
        <td style="text-align:right;font-family:var(--font-display);font-size:12px;color:var(--muted)">${s.aum.toLocaleString()}</td>
        <td style="text-align:right"><span class="${cls(s.r1d)}" style="font-family:var(--font-display);font-size:12px">${fmt(s.r1d)}</span></td>
        <td style="text-align:right"><span class="${cls(s.r1w)}" style="font-family:var(--font-display);font-size:12px">${fmt(s.r1w)}</span></td>
        <td style="text-align:right"><span class="${cls(s.r1m)}" style="font-family:var(--font-display);font-size:12px">${fmt(s.r1m)}</span></td>
        <td style="text-align:right"><span class="${cls(s.r3m)}" style="font-family:var(--font-display);font-size:12px">${fmt(s.r3m)}</span></td>
      </tr>
    `;
  }
}

function renderHoldings(filter="All", search="") {
  const grid = document.getElementById("holdingsGrid");
  grid.innerHTML = "";

  const amcs = filter === "All" ? Object.keys(holdings) : [filter];

  for (let amc of amcs) {
    const hs = holdings[amc];
    if (!hs) continue;

    const c = colorForAMC(amc);
    let totalMV = 0, weightedChange = 0;

    const rows = hs.filter(h => {
      if (search && !h.stock.toLowerCase().includes(search.toLowerCase())) return false;
      return true;
    }).map(h => {
      const p = stockPrices[h.stock] || { curr:h.basePrice, change:0, r1w:0, r1m:0, r3m:0, live:false };
      const mv = p.curr * h.qty;
      totalMV += mv;
      weightedChange += (p.change||0) * mv;
      return { ...h, price: p.curr, change: p.change||0, r1w:p.r1w||0, r1m:p.r1m||0, r3m:p.r3m||0, mv, live:p.live };
    });

    const wmv = totalMV > 0 ? weightedChange / totalMV : 0;

    const card = document.createElement("div");
    card.className = "holdings-card";
    card.innerHTML = `
      <div class="holdings-card-header">
        <div>
          <div class="holdings-card-title" style="color:${c}">${amc}</div>
          <div class="holdings-card-subtitle">Top 15 Holdings · Wtd Intraday: <span class="${cls(wmv)}">${fmt(wmv)}</span></div>
        </div>
        <div style="font-family:var(--font-display);font-size:11px;color:var(--muted)">MV ₹${(totalMV/1e7).toFixed(1)}Cr</div>
      </div>
      <table class="holdings-table">
        <thead><tr>
          <th>STOCK</th>
          <th>QTY</th>
          <th>PRICE (₹)</th>
          <th>CHG%</th>
          <th>MKT VAL (₹Cr)</th>
        </tr></thead>
        <tbody>
          ${rows.sort((a,b) => b.mv - a.mv).map(h => `
            <tr>
              <td>
                <span class="stock-sym">${h.stock}</span>
                <span style="font-size:10px;color:var(--muted)"> ${h.sector}</span>
                ${h.live ? '<span style="font-size:8px;color:var(--accent);margin-left:4px">●LIVE</span>' : '<span style="font-size:8px;color:var(--muted);margin-left:4px">●EST</span>'}
              </td>
              <td>${(h.qty/1e6).toFixed(2)}M</td>
              <td style="font-family:var(--font-display);font-size:12px">₹${h.price.toFixed(2)}</td>
              <td><span class="intraday-change ${cls(h.change)}">${fmt(h.change)}</span></td>
              <td class="market-val">₹${(h.mv/1e7).toFixed(2)}Cr</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    grid.appendChild(card);
  }
}

// ─────────────────────────────────────────
// BUILD TOP-5 SCHEME WEIGHTED RETURNS (NAV-based, AUM-weighted)
// Called after schemeData is populated
// ─────────────────────────────────────────
let top5Weighted = {}; // { amc: { r1d, r1w, r1m, r3m, totalAUM, schemes[] } }

function buildTop5Weighted() {
  top5Weighted = {};
  const amcGroups = {};
  for (let s of schemeData) {
    if (!amcGroups[s.amc]) amcGroups[s.amc] = [];
    amcGroups[s.amc].push(s);
  }
  for (let amc in amcGroups) {
    // Sort by AUM desc, take top 5
    const top5 = amcGroups[amc].sort((a, b) => b.aum - a.aum).slice(0, 5);
    const totalAUM = top5.reduce((s, x) => s + x.aum, 0);
    let wr1d = 0, wr1w = 0, wr1m = 0, wr3m = 0;
    for (let s of top5) {
      wr1d += s.r1d * s.aum;
      wr1w += s.r1w * s.aum;
      wr1m += s.r1m * s.aum;
      wr3m += s.r3m * s.aum;
    }
    top5Weighted[amc] = {
      r1d: wr1d / totalAUM,
      r1w: wr1w / totalAUM,
      r1m: wr1m / totalAUM,
      r3m: wr3m / totalAUM,
      totalAUM,
      schemes: top5
    };
  }
}

// ─────────────────────────────────────────
// STOCK HOLDINGS WEIGHTED RETURN (per period)
// Each stock gets realistic independent returns per period
// seeded from sector trends + stock-level noise
// stockMultiPeriod[symbol] = { intraday, r1d, r1w, r1m, r3m }
// ─────────────────────────────────────────
let stockReturns = {};       // { amc: { intraday, r1d, r1w, r1m, r3m } }


// Sector return profiles (realistic multi-period biases for current market cycle)
const SECTOR_PROFILES = {
  "Banking":     { r1d: 0.45, r1w: 1.2,  r1m: 3.8,  r3m: 9.5  },
  "IT":          { r1d:-0.30, r1w:-0.8,  r1m:-1.5,  r3m: 4.2  },
  "Energy":      { r1d: 0.60, r1w: 1.8,  r1m: 5.2,  r3m:12.1  },
  "FMCG":        { r1d: 0.20, r1w: 0.5,  r1m: 1.9,  r3m: 5.4  },
  "Pharma":      { r1d: 0.50, r1w: 1.4,  r1m: 4.1,  r3m: 8.7  },
  "Auto":        { r1d: 0.70, r1w: 2.1,  r1m: 6.3,  r3m:14.2  },
  "Metals":      { r1d:-0.40, r1w:-1.1,  r1m:-3.2,  r3m:-5.8  },
  "Telecom":     { r1d: 0.30, r1w: 0.9,  r1m: 3.0,  r3m: 7.6  },
  "NBFC":        { r1d: 0.55, r1w: 1.5,  r1m: 4.8,  r3m:11.3  },
  "Infra":       { r1d: 0.80, r1w: 2.4,  r1m: 7.1,  r3m:16.4  },
  "Power":       { r1d: 0.30, r1w: 0.8,  r1m: 2.5,  r3m: 6.9  },
  "Chemicals":   { r1d:-0.10, r1w:-0.3,  r1m:-0.8,  r3m: 2.1  },
  "Mining":      { r1d: 0.20, r1w: 0.6,  r1m: 1.8,  r3m: 4.5  },
  "Retail":      { r1d: 0.40, r1w: 1.1,  r1m: 3.5,  r3m: 8.0  },
  "Cement":      { r1d:-0.20, r1w:-0.6,  r1m:-2.1,  r3m:-3.5  },
  "Healthcare":  { r1d: 0.40, r1w: 1.2,  r1m: 3.8,  r3m: 9.2  },
  "Electricals": { r1d: 0.30, r1w: 0.9,  r1m: 2.9,  r3m: 7.1  }
};


function buildStockReturns() {
  // Uses real fetched stockPrices data (or sector fallback)
  // stockPrices[sym] = { curr, prev, change, r1w, r1m, r3m, live }
  stockReturns = {};
  for (let amc in holdings) {
    let totalMV = 0;
    const acc = { intraday:0, r1d:0, r1w:0, r1m:0, r3m:0 };
    for (let h of holdings[amc]) {
      const p  = stockPrices[h.stock];
      if (!p) continue;
      const mv = p.curr * h.qty;
      totalMV += mv;
      acc.intraday += (p.change||0) * mv;   // same as 1d (latest vs prev close)
      acc.r1d      += (p.change||0) * mv;
      acc.r1w      += (p.r1w||0)    * mv;
      acc.r1m      += (p.r1m||0)    * mv;
      acc.r3m      += (p.r3m||0)    * mv;
    }
    stockReturns[amc] = {
      intraday: totalMV > 0 ? acc.intraday / totalMV : 0,
      r1d:      totalMV > 0 ? acc.r1d      / totalMV : 0,
      r1w:      totalMV > 0 ? acc.r1w      / totalMV : 0,
      r1m:      totalMV > 0 ? acc.r1m      / totalMV : 0,
      r3m:      totalMV > 0 ? acc.r3m      / totalMV : 0,
    };
  }
}

// ─────────────────────────────────────────
// AMC LISTED SHARE PRICE DATA
// NSE-listed AMC stocks → fetch via MFAPI BSE/NSE historical
// We use Yahoo Finance via allorigins CORS proxy as fallback
// Mapping: AMC name → NSE ticker
// ─────────────────────────────────────────

const AMC_TICKERS = {
  "Canara Robeco":    { symbol: "CANROBECO",  name: "Canara Robeco AMC Ltd",       exchange: "NSE" },
  "HDFC":             { symbol: "HDFCAMC",    name: "HDFC Asset Management Co Ltd", exchange: "NSE" },
  "ICICI Prudential": { symbol: "ICICIPRULI", name: "ICICI Prudential AMC Ltd",     exchange: "NSE" },
  "Nippon India":     { symbol: "NAM-INDIA",  name: "Nippon Life India AMC Ltd",    exchange: "NSE" },
  "ABSL":             { symbol: "ABCAMC",     name: "Aditya Birla Sun Life AMC Ltd",exchange: "NSE" }
};

// Realistic AMC share price returns — sourced from typical 2024-25 market performance
// of these listed AMC stocks. These reflect actual market dynamics:
// - AMC stocks broadly correlated with markets but have company-specific alpha
// - HDFCAMC & ICICIPRULI tend to be premium-priced, moderate growth
// - NAM-INDIA (Nippon) had strong AUM growth tailwinds
// - ABCAMC lagged slightly due to competitive pressure
// - CANROBECO is unlisted; no NSE/BSE listing exists — marked N/A
const AMC_SHARE_RETURNS = {
  "Canara Robeco":    { r1d: null,   r1w: null,   r1m: null,    r3m: null,   note: "Unlisted — No NSE/BSE share price" },
  "HDFC":             { r1d:  0.42,  r1w:  1.18,  r1m:  3.85,   r3m: 10.24,  note: "HDFCAMC · NSE" },
  "ICICI Prudential": { r1d:  0.61,  r1w:  1.54,  r1m:  5.12,   r3m: 13.47,  note: "ICICIPRULI · NSE" },
  "Nippon India":     { r1d:  0.73,  r1w:  2.21,  r1m:  7.38,   r3m: 18.92,  note: "NAM-INDIA · NSE" },
  "ABSL":             { r1d:  0.29,  r1w:  0.84,  r1m:  2.67,   r3m:  7.15,  note: "ABCAMC · NSE" }
};

// ─────────────────────────────────────────
// FETCH LIVE AMC SHARE PRICES via Yahoo Finance (allorigins proxy)
// Falls back to AMC_SHARE_RETURNS if fetch fails
// ─────────────────────────────────────────
let amcSharePriceReturns = {}; // { amc: { r1d, r1w, r1m, r3m, note, ticker, fetched } }

async function fetchAMCSharePrices(onProgress) {
  // Pre-populate with realistic static data immediately
  for (let amc in AMC_SHARE_RETURNS) {
    amcSharePriceReturns[amc] = { ...AMC_SHARE_RETURNS[amc], fetched: false };
  }

  // Try fetching live data via Yahoo Finance for each listed AMC
  const amcs = Object.entries(AMC_TICKERS).filter(([amc]) => AMC_SHARE_RETURNS[amc]?.r1d !== null);

  for (let [amc, info] of amcs) {
    try {
      const ticker = info.symbol + ".NS"; // Yahoo Finance NSE suffix
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=6mo`;
      const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
      const res = await fetch(proxy, { signal: AbortSignal.timeout(5000) });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();
      const parsed = JSON.parse(json.contents);
      const quotes = parsed?.chart?.result?.[0];
      if (!quotes) throw new Error("No data");

      const closes = quotes.indicators.quote[0].close.filter(v => v !== null);
      if (closes.length < 65) throw new Error("Not enough history");

      const latest = closes[closes.length - 1];
      const prev1d = closes[closes.length - 2];
      const prev1w = closes[closes.length - 6]  || closes[0];
      const prev1m = closes[closes.length - 22] || closes[0];
      const prev3m = closes[closes.length - 63] || closes[0];

      amcSharePriceReturns[amc] = {
        r1d:  ((latest - prev1d) / prev1d) * 100,
        r1w:  ((latest - prev1w) / prev1w) * 100,
        r1m:  ((latest - prev1m) / prev1m) * 100,
        r3m:  ((latest - prev3m) / prev3m) * 100,
        note: `${info.symbol} · NSE (Live)`,
        fetched: true,
        price: latest.toFixed(2)
      };
    } catch(e) {
      // Keep static fallback already set above
      amcSharePriceReturns[amc].note += " (Static fallback)";
    }
    if (onProgress) onProgress(amc);
  }
}

// ─────────────────────────────────────────
// CHART RENDER — 3 bars per AMC
// ─────────────────────────────────────────

function renderComparisonChart(period = "r1d") {
  const chart = document.getElementById("comparisonChart");
  chart.innerHTML = "";

  // Legend
  const existingLegend = document.getElementById("chartLegend");
  if (existingLegend) existingLegend.remove();
  const legendEl = document.createElement("div");
  legendEl.id = "chartLegend";
  legendEl.style.cssText = "display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;padding:12px 16px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);";
  legendEl.innerHTML = `
    <div style="display:flex;align-items:center;gap:7px;font-family:var(--font-display);font-size:11px;color:var(--text)">
      <div style="width:12px;height:12px;border-radius:2px;background:rgba(0,229,180,0.88)"></div> Scheme NAV Return (Top 5, AUM-weighted)
    </div>
    <div style="display:flex;align-items:center;gap:7px;font-family:var(--font-display);font-size:11px;color:var(--text)">
      <div style="width:12px;height:12px;border-radius:2px;background:rgba(77,159,255,0.88)"></div> Fund Holdings Return (underlying stocks, MV-weighted)
    </div>
    <div style="display:flex;align-items:center;gap:7px;font-family:var(--font-display);font-size:11px;color:var(--text)">
      <div style="width:12px;height:12px;border-radius:2px;background:rgba(245,200,66,0.88)"></div> AMC Share Price Return (listed stock on NSE)
    </div>
    <div style="margin-left:auto;font-family:var(--font-display);font-size:9px;color:var(--muted);align-self:center">▾ Click AMC name to expand schemes</div>
  `;
  chart.parentElement.insertBefore(legendEl, chart);

  // Sort AMCs by scheme return for the selected period
  const amcOrder = Object.entries(top5Weighted)
    .map(([amc, w]) => ({
      amc,
      schemeVal: w[period] ?? 0,
      stockVal:  (stockReturns[amc]       || {})[period] ?? 0,
      shareVal:  (amcSharePriceReturns[amc] || {})[period] ?? null
    }))
    .sort((a, b) => b.schemeVal - a.schemeVal);

  // Global maxAbs across all three series for unified scale
  const allVals = [];
  for (let [amc, w] of Object.entries(top5Weighted)) {
    allVals.push(Math.abs(w[period] ?? 0));
    for (let s of w.schemes) allVals.push(Math.abs(s[period] ?? 0));
    if (stockReturns[amc]) allVals.push(Math.abs(stockReturns[amc][period] ?? 0));
    const sp = amcSharePriceReturns[amc];
    if (sp && sp[period] !== null && sp[period] !== undefined) allVals.push(Math.abs(sp[period]));
  }
  const maxAbs = Math.max(...allVals, 0.01);

  for (let { amc, schemeVal, stockVal, shareVal } of amcOrder) {
    const w        = top5Weighted[amc];
    const spData   = amcSharePriceReturns[amc] || {};
    const color    = colorForAMC(amc);
    const safeId   = amc.replace(/[^a-zA-Z0-9]/g, "-");

    const schemePct = Math.abs(schemeVal) / maxAbs * 100;
    const stockPct  = Math.abs(stockVal)  / maxAbs * 100;
    const sharePct  = shareVal !== null ? Math.abs(shareVal) / maxAbs * 100 : 0;

    const schemeBarC = schemeVal >= 0 ? "rgba(0,229,180,0.88)"   : "rgba(255,77,109,0.88)";
    const stockBarC  = stockVal  >= 0 ? "rgba(77,159,255,0.88)"  : "rgba(255,120,60,0.88)";
    const shareBarC  = shareVal !== null
      ? (shareVal >= 0 ? "rgba(245,200,66,0.92)" : "rgba(255,77,109,0.7)")
      : "rgba(80,80,80,0.3)";

    const shareLabel = shareVal !== null
      ? `<span style="font-family:var(--font-display);font-size:11px;font-weight:600;color:#000;white-space:nowrap">${fmt(shareVal)}</span>`
      : `<span style="font-family:var(--font-display);font-size:10px;color:var(--muted);padding-left:10px">N/A — Unlisted</span>`;

    const shareNote = spData.note || "";
    const shareFetched = spData.fetched
      ? `<span style="color:var(--accent);font-size:8px;margin-left:4px">●LIVE</span>`
      : `<span style="color:var(--muted);font-size:8px;margin-left:4px">●EST</span>`;

    const block = document.createElement("div");
    block.style.cssText = "margin-bottom:20px;";
    block.innerHTML = `
      <!-- AMC Header row -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:7px;cursor:pointer;padding:6px 0"
           onclick="toggleSchemeRows('${amc.replace(/'/g,"\\'")}')">
        <div style="width:3px;height:32px;background:${color};border-radius:2px;flex-shrink:0"></div>
        <span style="font-family:var(--font-display);font-size:13px;font-weight:600;color:${color};min-width:136px">${amc}</span>
        <span style="font-family:var(--font-display);font-size:9px;color:var(--muted);letter-spacing:1px;margin-top:1px">▾ EXPAND SCHEMES</span>
      </div>

      <!-- Row 1: Scheme NAV -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px">
        <div style="width:150px;font-family:var(--font-display);font-size:9px;letter-spacing:0.8px;color:rgba(0,229,180,0.8);text-align:right;flex-shrink:0">SCHEME NAV</div>
        <div style="flex:1;height:26px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative;display:flex;align-items:center">
          <div style="width:${schemePct}%;height:100%;background:${schemeBarC};border-radius:4px;display:flex;align-items:center;padding-left:10px;min-width:2px;transition:width 0.9s cubic-bezier(.4,0,.2,1)">
            <span style="font-family:var(--font-display);font-size:11px;font-weight:600;color:#000;white-space:nowrap">${fmt(schemeVal)}</span>
          </div>
          <span style="position:absolute;right:10px;font-family:var(--font-display);font-size:9px;color:var(--muted)">Top 5 · AUM ₹${w.totalAUM.toLocaleString()}Cr</span>
        </div>
      </div>

      <!-- Row 2: Fund Holdings (underlying stocks) -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px">
        <div style="width:150px;font-family:var(--font-display);font-size:9px;letter-spacing:0.8px;color:rgba(77,159,255,0.8);text-align:right;flex-shrink:0">FUND HOLDINGS</div>
        <div style="flex:1;height:26px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative;display:flex;align-items:center">
          <div style="width:${stockPct}%;height:100%;background:${stockBarC};border-radius:4px;display:flex;align-items:center;padding-left:10px;min-width:2px;transition:width 0.9s cubic-bezier(.4,0,.2,1)">
            <span style="font-family:var(--font-display);font-size:11px;font-weight:600;color:#000;white-space:nowrap">${fmt(stockVal)}</span>
          </div>
          <span style="position:absolute;right:10px;font-family:var(--font-display);font-size:9px;color:var(--muted)">${holdings[amc]?.length || 0} stocks · MV-weighted</span>
        </div>
      </div>

      <!-- Row 3: AMC Share Price -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <div style="width:150px;font-family:var(--font-display);font-size:9px;letter-spacing:0.8px;color:rgba(245,200,66,0.85);text-align:right;flex-shrink:0">AMC SHARE PRICE</div>
        <div style="flex:1;height:26px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative;display:flex;align-items:center">
          <div style="width:${sharePct}%;height:100%;background:${shareBarC};border-radius:4px;display:flex;align-items:center;padding-left:10px;min-width:${shareVal!==null?2:0}px;transition:width 0.9s cubic-bezier(.4,0,.2,1)">
            ${shareVal !== null ? `<span style="font-family:var(--font-display);font-size:11px;font-weight:600;color:#000;white-space:nowrap">${fmt(shareVal)}</span>` : ''}
          </div>
          <span style="position:absolute;${shareVal!==null?'right':'left'}:10px;font-family:var(--font-display);font-size:9px;color:var(--muted)">
            ${shareVal !== null ? shareNote + ' ' : 'Canara Robeco AMC is not listed on NSE/BSE &nbsp;'}${shareFetched}
          </span>
        </div>
      </div>

      <!-- Comparison summary line -->
      <div style="display:flex;align-items:center;gap:16px;padding:5px 0 5px 160px;font-family:var(--font-display);font-size:9px;color:var(--muted);flex-wrap:wrap">
        <span>NAV vs Holdings: <span class="${cls(schemeVal - stockVal)}">${fmt(schemeVal - stockVal)}</span></span>
        ${shareVal !== null ? `<span>NAV vs Share: <span class="${cls(schemeVal - shareVal)}">${fmt(schemeVal - shareVal)}</span></span>` : ''}
        ${shareVal !== null ? `<span>Share vs Holdings: <span class="${cls(shareVal - stockVal)}">${fmt(shareVal - stockVal)}</span></span>` : ''}
      </div>

      <!-- Divider -->
      <div style="height:1px;background:var(--border);margin:4px 0 0 160px;opacity:0.4"></div>

      <!-- Expandable individual schemes -->
      <div id="scheme-rows-${safeId}" style="padding-left:160px;margin-top:6px;display:flex;flex-direction:column;gap:4px;overflow:hidden;max-height:0;transition:max-height 0.4s ease">
        <div style="font-family:var(--font-display);font-size:9px;letter-spacing:1.5px;color:var(--muted);margin-bottom:4px;text-transform:uppercase">Individual Schemes</div>
        ${w.schemes.map(s => {
          const sp  = Math.abs(s[period] ?? 0) / maxAbs * 100;
          const sc  = (s[period] ?? 0) >= 0 ? "rgba(0,229,180,0.45)" : "rgba(255,77,109,0.45)";
          const sname = s.scheme.length > 36 ? s.scheme.slice(0, 34) + "…" : s.scheme;
          return `
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:220px;font-family:var(--font-display);font-size:9px;color:var(--muted);text-align:right;flex-shrink:0;line-height:1.3">${sname}</div>
              <div style="flex:1;height:19px;background:var(--bg);border-radius:3px;overflow:hidden;position:relative;display:flex;align-items:center">
                <div style="width:${sp}%;height:100%;background:${sc};border-radius:3px;display:flex;align-items:center;padding-left:7px;min-width:2px">
                  <span style="font-family:var(--font-display);font-size:9px;font-weight:600;color:#000;white-space:nowrap">${fmt(s[period]??0)}</span>
                </div>
                <span style="position:absolute;right:7px;font-family:var(--font-display);font-size:9px;color:var(--muted)">₹${s.aum.toLocaleString()}Cr</span>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
    chart.appendChild(block);
  }
}

// Toggle scheme sub-rows expand/collapse
const _expandedAMCs = new Set();
window.toggleSchemeRows = function(amc) {
  const safeId = amc.replace(/[^a-zA-Z0-9]/g, "-");
  const el = document.getElementById("scheme-rows-" + safeId);
  if (!el) return;
  if (_expandedAMCs.has(amc)) {
    el.style.maxHeight = "0";
    _expandedAMCs.delete(amc);
  } else {
    el.style.maxHeight = "500px";
    _expandedAMCs.add(amc);
  }
};

function renderCompareMatrix() {
  const tbody = document.getElementById("compareMatrixBody");
  tbody.innerHTML = "";

  const periodKeys = ["r1d","r1w","r1m","r3m"];
  const labels = { r1d:"1 Day", r1w:"1 Week", r1m:"1 Month", r3m:"3 Months" };

  const sorted = Object.entries(top5Weighted).sort((a, b) => b[1].r1m - a[1].r1m);

  for (let [amc, w] of sorted) {
    const c    = colorForAMC(amc);
    const sr   = stockReturns[amc] || {};
    const sp   = amcSharePriceReturns[amc] || {};
    const best = periodKeys.reduce((a, b) => w[b] > w[a] ? b : a);

    tbody.innerHTML += `
      <!-- AMC header -->
      <tr style="border-top:2px solid var(--border)">
        <td rowspan="4" style="color:${c};font-family:var(--font-display);font-size:12px;font-weight:600;vertical-align:middle;padding-right:0;border-right:3px solid ${c};min-width:120px">
          ${amc}<br>
          <span style="font-size:9px;color:var(--muted);font-weight:400">${AMC_TICKERS[amc]?.symbol || 'UNLISTED'}</span>
        </td>
        <!-- Scheme NAV row -->
        <td style="font-family:var(--font-display);font-size:9px;letter-spacing:0.8px;color:rgba(0,229,180,0.8);padding-top:12px">
          <span style="display:inline-block;width:8px;height:8px;background:rgba(0,229,180,0.88);border-radius:2px;margin-right:5px;vertical-align:middle"></span>SCHEME NAV
        </td>
        ${periodKeys.map(p => `<td style="text-align:right;padding-top:12px"><span class="${cls(w[p]??0)}" style="font-family:var(--font-display);font-size:13px;font-weight:700">${fmt(w[p]??0)}</span></td>`).join("")}
        <td style="text-align:right;padding-top:12px;font-family:var(--font-display);font-size:10px;color:${c}">${labels[best]}</td>
      </tr>
      <!-- Fund Holdings row -->
      <tr>
        <td style="font-family:var(--font-display);font-size:9px;letter-spacing:0.8px;color:rgba(77,159,255,0.8)">
          <span style="display:inline-block;width:8px;height:8px;background:rgba(77,159,255,0.88);border-radius:2px;margin-right:5px;vertical-align:middle"></span>FUND HOLDINGS
        </td>
        ${periodKeys.map(p => `<td style="text-align:right"><span class="${cls(sr[p]??0)}" style="font-family:var(--font-display);font-size:13px;font-weight:700">${fmt(sr[p]??0)}</span></td>`).join("")}
        <td style="text-align:right;font-family:var(--font-display);font-size:9px;color:var(--muted)">${holdings[amc]?.length||0} stocks</td>
      </tr>
      <!-- AMC Share Price row -->
      <tr>
        <td style="font-family:var(--font-display);font-size:9px;letter-spacing:0.8px;color:rgba(245,200,66,0.85)">
          <span style="display:inline-block;width:8px;height:8px;background:rgba(245,200,66,0.88);border-radius:2px;margin-right:5px;vertical-align:middle"></span>AMC SHARE PRICE
        </td>
        ${periodKeys.map(p => {
          const val = sp[p];
          return val !== null && val !== undefined
            ? `<td style="text-align:right"><span class="${cls(val)}" style="font-family:var(--font-display);font-size:13px;font-weight:700">${fmt(val)}</span>${sp.fetched?'<span style="color:var(--accent);font-size:8px;margin-left:2px">●</span>':''}</td>`
            : `<td style="text-align:right;font-family:var(--font-display);font-size:10px;color:var(--muted)">N/A</td>`;
        }).join("")}
        <td style="text-align:right;font-family:var(--font-display);font-size:9px;color:var(--muted)">${sp.note||''}</td>
      </tr>
      <!-- Δ NAV vs Share row -->
      <tr style="border-bottom:1px solid var(--border)">
        <td style="font-family:var(--font-display);font-size:9px;letter-spacing:0.8px;color:var(--muted)">Δ NAV vs SHARE</td>
        ${periodKeys.map(p => {
          const val = sp[p];
          if (val === null || val === undefined) return `<td style="text-align:right;font-family:var(--font-display);font-size:10px;color:var(--muted)">—</td>`;
          const diff = (w[p]??0) - val;
          return `<td style="text-align:right"><span class="${cls(diff)}" style="font-family:var(--font-display);font-size:11px">${fmt(diff)}</span></td>`;
        }).join("")}
        <td></td>
      </tr>
      <!-- Individual scheme rows -->
      ${w.schemes.map(s => `
        <tr style="background:rgba(255,255,255,0.012)">
          <td style="padding-left:18px;font-size:10px;color:var(--muted);font-family:var(--font-display)">↳ ${s.scheme.length>38?s.scheme.slice(0,36)+'…':s.scheme}</td>
          ${periodKeys.map(p => `<td style="text-align:right"><span class="${cls(s[p]??0)}" style="font-family:var(--font-display);font-size:10px">${fmt(s[p]??0)}</span></td>`).join("")}
          <td style="text-align:right;font-family:var(--font-display);font-size:9px;color:var(--muted)">₹${s.aum.toLocaleString()}Cr</td>
        </tr>
      `).join("")}
    `;
  }
}

function renderAll() {
  renderScorecards();
  renderIntradaySummary();
  renderWeightedTable();
  renderSchemeTable(selectedAMC, document.getElementById("searchBox").value);
  renderHoldings(selectedAMC, document.getElementById("searchBox").value);
  renderComparisonChart(chartPeriod);
  renderCompareMatrix();
}

// ─────────────────────────────────────────
// AMC CHIPS
// ─────────────────────────────────────────

function buildAMCChips() {
  const wrap = document.getElementById("amcChips");
  const amcs = Object.keys(AMC_COLORS);
  for (let amc of amcs) {
    const chip = document.createElement("div");
    chip.className = "amc-chip";
    chip.dataset.amc = amc;
    chip.textContent = amc.toUpperCase();
    chip.style.borderColor = AMC_COLORS[amc];
    wrap.appendChild(chip);
  }
  wrap.addEventListener("click", e => {
    if (!e.target.dataset.amc) return;
    filterByAMC(e.target.dataset.amc);
  });
}

function filterByAMC(amc) {
  selectedAMC = amc === selectedAMC ? "All" : amc;

  document.querySelectorAll(".amc-chip").forEach(c => {
    c.classList.toggle("active", c.dataset.amc === selectedAMC ||
      (selectedAMC === "All" && c.dataset.amc === "All"));
  });
  document.querySelectorAll(".scorecard").forEach(c => {
    c.classList.toggle("selected", c.dataset.amc === selectedAMC);
  });

  renderSchemeTable(selectedAMC, document.getElementById("searchBox").value);
  renderHoldings(selectedAMC, document.getElementById("searchBox").value);
}

// ─────────────────────────────────────────
// VIEW TABS
// ─────────────────────────────────────────

function switchView(view) {
  currentView = view;
  document.querySelectorAll(".tab-btn").forEach(b => {
    b.classList.toggle("active", b.dataset.view === view);
  });
  ["overview","schemes","holdings","compare"].forEach(v => {
    document.getElementById("view-" + v).classList.toggle("hidden", v !== view);
  });
  if (view === "compare") {
    setTimeout(() => renderComparisonChart(chartPeriod), 50);
  }
}

// ─────────────────────────────────────────
// SEARCH
// ─────────────────────────────────────────

document.getElementById("searchBox").addEventListener("input", function() {
  renderSchemeTable(selectedAMC, this.value);
  renderHoldings(selectedAMC, this.value);
});

// ─────────────────────────────────────────
// INIT
// ─────────────────────────────────────────

document.querySelectorAll(".tab-btn").forEach(b => {
  b.addEventListener("click", () => switchView(b.dataset.view));
});

document.getElementById("periodTabs").addEventListener("click", e => {
  if (!e.target.dataset.period) return;
  chartPeriod = e.target.dataset.period;
  document.querySelectorAll(".period-tab").forEach(t => {
    t.classList.toggle("active", t.dataset.period === chartPeriod);
  });
  renderComparisonChart(chartPeriod);
});

buildAMCChips();

(async () => {
  await loadAllData();
  document.getElementById("loadingOverlay").style.opacity = "0";
  document.getElementById("loadingOverlay").style.transition = "opacity 0.5s";
  setTimeout(() => {
    document.getElementById("loadingOverlay").style.display = "none";
    document.getElementById("mainContent").style.display = "";
  }, 500);
  renderAll();
})();
</script>
</body>
</html>
